/**
 * # Firestore Security Rules
 *
 * ## Core Philosophy
 * This ruleset enforces a strict user-ownership model. Each authenticated user has
 * exclusive create, read, update, and delete (CRUD) access to their own profile
 * document. The primary goal is to securely manage user identity and subscription
 * status (`isPro`).
 *
 * ## Data Structure
 * The data structure is flat and user-centric. All data is stored in a top-level
 * `/users` collection. Each user's profile is a single document within this
 * collection, with the document ID matching the user's authentication UID
 * (e.g., `/users/{userId}`).
 *
 * ## Key Security Decisions
 * - **No User Listing**: To protect user privacy and prevent data scraping, it is
 *   explicitly forbidden to list all documents in the `/users` collection.
 * - **Ownership Integrity**: When a user profile is created, a rule enforces
 *   that the user's UID is stored inside the document's `id` field. This `id`
 *   field is then made immutable on all subsequent updates, creating a permanent
 *   and trustworthy link between the document data and its owner.
 * - **Pro Status Management**: The `isPro` status and `proExpiresAt` can be
 *   updated, but only by the user on their own profile. Server-side checks are
 *   expected to verify payments before this is set.
 * - **Default Secure**: Access is denied by default. Permissions are only granted
 *   explicitly.
 *
 * ## Denormalization for Authorization
 * The data model is already optimized for security rules. Authorization-critical
 * data, such as the `isPro` and `proExpiresAt` flags, are stored directly on the
 * `/users/{userId}` document. This design choice is deliberate and crucial, as it
 * allows for fast, simple, and cost-effective authorization checks without
 * requiring any slow or expensive `get()` calls to other documents.
 */
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user's UID matches the document's owner ID
     * from the path. This is the primary ownership check.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if the user is the owner of an existing document. This is crucial
     * for safe updates and deletes, preventing operations on non-existent data.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * On create, validates that the internal 'id' field in the document data
     * matches the document's path ID (`userId`). This enforces relational
     * integrity from the moment of creation.
     */
    function hasValidUserProfileDataOnCreate(userId) {
      return request.resource.data.id == userId;
    }

    /**
     * On update, ensures critical relational fields like the user 'id'
     * are not changed, preserving the integrity of the ownership link.
     * Allows changes to other fields like 'isPro', 'proExpiresAt', 'dailyUsage', and 'lastUsageDate'.
     */
    function isImmutableUserProfileData() {
      // Allow changes to all fields except the id.
      return request.resource.data.id == resource.data.id;
    }

    // ------------------------------------------------------------------------
    // Collection Rules: /users
    // ------------------------------------------------------------------------

    match /users/{userId} {
      allow get: if isOwner(userId);
      allow create: if isOwner(userId) && hasValidUserProfileDataOnCreate(userId);
      allow update: if isExistingOwner(userId) && isImmutableUserProfileData();
      allow delete: if isExistingOwner(userId);

      // Allow users to create and read their own interactions for progress tracking
      match /interactions/{interactionId} {
        allow list, get: if isOwner(userId);
        // Users can create interactions, but not update or delete them to maintain integrity.
        allow create: if isOwner(userId);
      }
    }
  }
}
